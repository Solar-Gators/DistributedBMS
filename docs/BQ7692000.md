# BQ7692000PW Driver
## Overview

This file documents the behavior, interfaces, and scaling formulas used by the BQ7692000PW class, a driver for TI’s BQ7692000 battery monitor / protector IC. The driver provides APIs for:

- Initializing the ADC and Coulomb Counter (CC)
- Reading individual cell voltages
- Reading total pack voltage
- Reading Coulomb Counter (current sense) ADC data
- Reading die temperature
- Enabling and controlling active cell balancing
- Accessing device calibration values (ADC gain and offset)
- Reading device status flags

The driver uses readN() and writeN() helpers (implemented elsewhere) to transfer bytes over I2C.
Error propagation is handled using the TRY() macro: any HAL error immediately aborts the current function.

## Public API Documentation
### init()
#### Description

- Initializes the BQ7692000 for full operation.
- Call this once during system bring-up.

#### Steps performed:
- Configure the Coulomb Counter (initCC)
- Enable CC conversions (enableCCReading)
- Enable ADC subsystem (enableADC)

#### Returns
- HAL_OK
- HAL_ERROR if any step fails


### *getCC(uint16_t data)
#### Description
- Reads the Coulomb Counter output (raw ADC result from CC_HI/CC_LO).

#### Steps performed:
- Calls checkCC(), which:
- Verifies a new CC sample is ready (SYS_STAT bit)
- Reads CC bytes into dataCC_
- Clears the CC-ready latch
- Combines the two bytes into a 16-bit integer

Output:
- Raw Coulomb Counter value (not converted to amps or coulombs)

returns

#### HAL_OK if CC ready and read successfully
- HAL_BUSY if CC not ready
- HAL_ERROR if any transaction/config error occurs

### getVC(std::array<uint16_t, CELL_COUNT> &vc_values)
#### Description
- Reads and converts all individual cell voltages.

#### Steps performed:
- checkVC() reads VCx registers into dataVC_
- Reads ADC gain (getADCGain)
- Reads ADC offset (getADCOffset)
- For each cell:
- cell_voltage = rawADC * gain + offset (offset = signed offset code)
- Scaling: gain = (365 + gain_code) / 1000 (per TI datasheet)

Output:
- vc_values[cell] contains a scaled integer (commonly millivolts)

Returns

HAL_OK on success

HAL_ERROR otherwise

*getBAT(uint16_t data)
Description

Reads and converts the total pack voltage.

Formula (TI datasheet):
V(BAT) = 4 × GAIN × ADC(BAT) + (#Cells × OFFSET)

Steps:

Read BAT registers into dataBAT_

Read calibration gain and offset

Perform formula and output as scaled integer

Returns:

HAL_OK

HAL_ERROR

*getDieTemp(uint16_t data)
Description

Reads die temperature using TS1 ADC channel.

Datasheet equations:
V25   = 1.200 V
VTSX  = raw * 382 µV
TEMP  = 25°C – ((VTSX – V25) / 0.0042)

Output:

Temperature in °C as integer

Returns:

HAL_OK

HAL_ERROR

*getActiveBalancing(uint8_t activeBal)

Reads CELL_BAL1 register to retrieve active balancing enable bits.

Bits correspond to each cell

Upper 3 bits are reserved (always 0)

Returns HAL_OK unless I2C operation fails.

*setActiveBalancing(uint8_t activeBal)

Writes CELL_BAL1 register, while masking the upper reserved bits:

write = activeBal & ACTIVE_BAL_MASK


Returns HAL_OK or HAL_ERROR.

*getADCGain(uint8_t data)

Reads ADCGAIN1 and ADCGAIN2 to reconstruct the gain calibration value.

Formula:
gain = ((reg1 & 0x0C) << 1) | ((reg2 & 0xE0) >> 5)


Returns the raw gain code, not the floating-point coefficient.

*getADCOffset(uint8_t data)

Reads the ADCOFFSET register.

Offset is a signed calibration value

Used along with gain to convert ADC codes

Returns HAL_OK.

checkStatus()

Reads the SYS_STAT register into status_.

If any error bits are set:

Returns HAL_ERROR

Future designs may include detailed fault logging

Otherwise returns HAL_OK.

Private/Internal API Documentation
initCC()

Writes CC configuration mask to CC_CFG register.

Configures the internal Coulomb Counter but does not enable it—use enableCCReading() after this.

Returns HAL_OK or HAL_ERROR.

enableCCReading()

Enables the Coulomb Counter by setting the CC_EN bit in SYS_CTRL2.

Loads SYS_CTRL2 → ORs the enable bit → writes back.

enableADC()

Enables the voltage/temperature ADC subsystem by setting ADC_EN bit in SYS_CTRL1.

checkVC()

Reads each cell voltage register pair sequentially:

VC1_HI/LO
VC2_HI/LO
...


Into dataVC_.

CELL_COUNT is compile-time constant.

checkCC()
Steps:

checkStatus() (detects BQ faults)

Test CC-ready flag:

If not set → return HAL_BUSY

Read CC_HI/CC_LO → store in dataCC_

Clear CC-ready latch by writing to SYS_STAT

Returns:

HAL_OK

HAL_BUSY

HAL_ERROR

Data Flow Summary
Function	Reads Raw ADC	Reads Calibration	Applies Scaling	Output
getVC()	Yes	Gain + Offset	Yes	Cell voltages
getBAT()	Yes	Gain + Offset	Yes	Pack voltage
getCC()	Yes	No	No	Raw CC value
getDieTemp()	Yes	No	TI formula	°C
getActiveBalancing()	Yes	No	No	Bitmask
Driver Usage Example
BQ7692000PW bq;

if (bq.init() != HAL_OK) {
    // Handle initialization error
}

std::array<uint16_t, CELL_COUNT> vc;
uint16_t batt_mv, cc_raw, temp_c;

bq.getVC(vc);
bq.getBAT(&batt_mv);
bq.getCC(&cc_raw);
bq.getDieTemp(&temp_c);
